<html>
    <head>
        <title>Diamond-Square Algorithm</title>
    </head>
    <body>
        <canvas id="myCanvas" width="300" height="300"></canvas>
        <script>
            // Threadable / Parallel approach? Perhaps.
            let c = document.getElementById("myCanvas");
            let ctx = c.getContext("2d");
            let n = 8;
            let w = Math.pow(2, n)+1;
            let h = w;
            let px = ctx.createImageData(w,h);
            let d = px.data;
            console.log(d);
            const pix = (x, y) => 4 * (x + y * w);

            const square = (x1, y1, w, r) => {
                let ix1 = pix(x1, y1);
                let ix2 = pix(x1, y1+w-1);
                let ix3 = pix(x1+w-1, y1);
                let ix4 = pix(x1+w-1, y1+w-1);
                let ixc = pix(x1+(w-1)/2, y1+(w-1)/2);
               // console.log(`${x1+(w-1)/2}, ${y1+(w-1)/2}`);
                if(d[ixc+3] === 0){
                    let disturb = Math.floor(Math.random()*r)-r/2;
                    d[ixc] = Math.abs((Math.floor((d[ix1]+d[ix2]+d[ix3]+d[ix4])/4)+disturb)%256);
                    // d[ixc+1] = Math.floor((d[ix1+1]+d[ix2+1]+d[ix3+1]+d[ix4+1])/4);
                    // d[ixc+2] = Math.floor((d[ix1+2]+d[ix2+2]+d[ix3+2]+d[ix4+2])/4);
                    d[ixc+3] = 255;
                }
            };
            const diamond = (x1, y1, w, wg, r) => {
                //console.log(`begin diamond at ${x1}, ${y1}`);
                let ix = [[0, 0], [0, 0], [0, 0], [0, 0]];
                let half = (w-1)/2;
                ix[0] = [x1+half, y1];
                ix[1] = [x1, y1+half];
                ix[2] = [x1+half, y1+w-1];
                ix[3] = [x1+w-1, y1+half];
                for(let i = 0; i < ix.length; i++){
                    let c = 0;
                    let s = 0;
                    let x = 0, y = 1;
                    if(ix[i][x]-half >= 0){
                        c++;
                        let ix1 = pix(ix[i][x]-half, ix[i][y]);
                        s += d[ix1];
                        console.log(s);
                    }
                    if(ix[i][x]+half < wg){
                        c++;
                        let ix2 = pix(ix[i][x]+half, ix[i][y]);
                        s += d[ix2];
                        console.log(s);
                    }
                    if(ix[i][y]-half >= 0){
                        c++;
                        let ix3 = pix(ix[i][x], ix[i][y]-half);
                        s += d[ix3];
                        console.log(s);
                    }
                    if(ix[i][y]+half < wg){
                        c++;
                        let ix4 = pix(ix[i][x], ix[i][y]+half);
                        s += d[ix4];
                        console.log(s);
                    }
                    //console.log(`dia ${ix[i][x]}, ${ix[i][y]}`);                
                    let disturb = Math.floor(Math.random()*r)-r/2;
                    d[pix(ix[i][x], ix[i][y])] = Math.abs((Math.floor(s/c)+disturb)%256);
                    d[pix(ix[i][x], ix[i][y])+3] = 255;
                }
            };
            d[pix(0,0)] = Math.floor(Math.random()*255);
            d[pix(0,0)+3] = 255;
            d[pix(0,h-1)] = Math.floor(Math.random()*255);
            d[pix(0,h-1)+3] = 255;
            d[pix(w-1,0)] = Math.floor(Math.random()*255);
            d[pix(w-1,0)+3] = 255;
            d[pix(w-1,h-1)] = Math.floor(Math.random()*255);
            d[pix(w-1,h-1)+3] = 255;

            let r = 1024;
            for(let size = w; size > 2; size = (size - 1)/2+1, r /= 2){
                console.log(`iteration size ${size}`)
                for(let y = 0; y < w-1; y += size-1){
                    for(let x = 0; x < w-1; x += size-1){
                        console.log(`x ${x} y ${y}`)
                        square(x, y, size, r);
                        diamond(x, y, size, w, r);
                    }
                }
            }
            // square(0, 0, w);
            // diamond(0, 0, w, w);

            // square(0, 0, (w-1)/2+1);
            // diamond(0, 0, (w-1)/2+1, w);

            // square((w-1)/2, 0, (w-1)/2+1);
            // diamond((w-1)/2, 0, (w-1)/2+1, w);

            // square(0, (w-1)/2, (w-1)/2+1);
            // diamond(0, (w-1)/2, (w-1)/2+1, w);

            // square((w-1)/2, (w-1)/2, (w-1)/2+1);
            // diamond((w-1)/2, (w-1)/2, (w-1)/2+1, w);

            // for(let y = 0; y < h; y++){
            //     for(let x = 0; x < w; x++){
            //         let ix = 4 * (x + y * w);
            //         if(ix % 1 == 0){
            //             d[ix] = 255;
            //             d[ix+1] = 0;
            //             d[ix+2] = 0;
            //             d[ix+3] = 255;
            //         }
            //     }
            // }
            ctx.putImageData(px, 0, 0);
            ctx.stroke();
        </script>
    </body>
</html>